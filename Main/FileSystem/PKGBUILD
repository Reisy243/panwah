# Maintainer: Isaac (Reisy RedPanda) <opensrcrdp@gmail.com>
# Repo: Main
pkgname="FileSystem"
pkgver=Alpha_1.0
pkgrel=5
pkgdesc="Base WArch files"
arch=("x86_64" "aarch64")
url="https://reisy243.github.io/panwah"
srcurl="https://raw.githubusercontent.com/Reisy243/panwah/src/Main/$pkgname"
license=("unknown")
depends=("iana-etc")
backup=(
	"etc/crypttab"
	"etc/fstab"
	"etc/group"
	"etc/gshadow"
	"etc/host.conf"
	"etc/hosts"
	"etc/issue"
	"etc/ld.so.conf"
	"etc/nsswitch.conf"
	"etc/passwd"
	"etc/profile"
	"etc/resolv.conf"
	"etc/securetty"
	"etc/shadow"
	"etc/shells"
	"etc/subuid"
	"etc/subgid"
)
source=(
	"$srcurl/crypttab"
	"$srcurl/env-generator"
	"$srcurl/fstab"
	"$srcurl/group"
	"$srcurl/gshadow"
	"$srcurl/host.conf"
	"$srcurl/hosts"
	"$srcurl/issue"
	"$srcurl/ld.so.conf"
	"$srcurl/locale.sh"
	"$srcurl/nsswitch.conf"
	"$srcurl/os-release"
	"$srcurl/profile"
	"$srcurl/passwd"
	"$srcurl/resolv.conf"
	"$srcurl/securetty"
	"$srcurl/shadow"
	"$srcurl/shells"
	"$srcurl/sysctl"
	"$srcurl/sysusers"
	"$srcurl/tmpfiles"
	"$url/img/wah-logo.png"
	"$url/img/wah-logo.svg"
	"$url/img/wah-logo-text.svg"
	"$url/img/wah-logo-text-dark.svg"
)
sha256sums=(
	"e03bede3d258d680548696623d5979c6edf03272e801a813c81ba5a5c64f4f82"	# crypttab
	"ed0cb4f1db4021f8c3b5ce78fdf91d2c0624708f58f36c9cf867f4d93c3bc6da"	# env-generator
	"e54626e74ed8fee4173b62a545ab1c3a3a069e4217a0ee8fc398d9933e9c1696"	# fstab
	"244f0718ee2a9d6862ae59d6c18c1dd1568651eada91a704574fa527fbac2b3a"	# group
	"90d879374f77bac47f132164c1e7fc4892e994ff1d1ac376efa0c1c26ea37273"	# gshadow
	"4d7b647169063dfedbff5e1e22cee77bd1a4183dbcfd5e802e68939da4bbf733"	# host.conf
	"e48ace7c4215873921a745b5cd20203485f3b26624645803734372d6661f3792"	# hosts
	"64e8fa0697a90f4358d1774209d55c7422689e212b6a056dd557bb50c2586728"	# issue
	"dad04a370e488aa85fb0a813a5c83cf6fd981ce01883fc59685447b092de84b5"	# ld.so.conf
	"8ca2d8eef6fb5143c9ef7e9174ccfef59ac7ad2deee243574cd10c763156cc10"	# locale.sh
	"c8ee7a9faf798caab178ec51afae4146f1efd8a716b7acedf28345b6c75f9697"	# nsswitch.conf
	"a3fa53114f9bfc4a77b567c92a6b98ee7061d230fa3be973cb273cae97439e22"	# os-release
	"8f08231922fe185d3132f9aedded5cd688fb7c482a6f6f272402ded82fa4849a"	# profile
	"8909fc740f7cce4bfab2856ee67847ba4af815b93b18d9c67a8805e2d14f53bf"	# passwd
	"5557d8e601b17a80d1ea7de78a9869be69637cb6a02fbfe334e22fdf64e61d4c"	# resolv.conf
	"d88be2b45b43605ff31dd83d6a138069b6c2e92bc8989b7b9ab9eba8da5f8c7b"	# securetty
	"6e13705ac4d6f69cdba118c6b70c722346fd3c45224133e6bbfe28aca719563c"	# shadow
	"ec289c03aa0d150e90e8287f001c8e6552ab9dd54f450bdb5c2d2254e477965b"	# shells
	"89e43a0b7028f52d5c8e7fb961d962c4b4f4e9595880a6157274ddb2c7c0b6b4"	# sysctl
	"d4b24ad2c2c792fa1b492b30ff3129e9fe42f2b893dab4cc1316fb03c4176c52"	# sysusers
	"5d8e61479f0093852365090e84d8d95b1e7fccfab068274ee25863bde6ff3e07"	# tmpfiles
	"8e167fdd1deb7e14e869759b03703d0c57f090cf060336ad5588cf6b9e400ff9"	# wah-logo.png
	"9c17a4922e7a1afb2f0c3e407d02c8e21184b1a0af772ad363d0709bf55a7d4b"	# wah-logo.svg
	"a3efeefbccfe8a5cae1ae51b4e7abb6820d65fc4ab4f33712e7dc38d6a62dadc"	# wah-logo-text.svg
	"42b1e3964759d79463ce9cf96ec2eb0cdc4939acdadc1c40b3f65fd69de0aad5"	# wah-logo-text-dark.svg
)

package() {
	touch subgid subuid
	cd "$pkgdir"

	# Creating root file system
	install -d -m755 boot dev etc home mnt usr var opt run
	install -d -m555 proc sys
	install -d -m0750 root
	install -d -m1777 tmp

	# Configuring /etc and /usr/share/factory/etc
	install -d etc/{ld.so.conf.d,skel,profile.d} usr/share/factory/etc
	for Files in fstab group host.conf hosts issue ld.so.conf nsswitch.conf passwd resolv.conf securetty shells profile subuid subgid; do
		install -m644 $srcdir/$Files etc/
		install -m644 $srcdir/$Files usr/share/factory/etc/
	done
	ln -s ../proc/self/mounts etc/mtab
	for Files in gshadow shadow crypttab; do
		install -m600 "$srcdir"/$Files etc/
		install -m600 "$srcdir"/$Files usr/share/factory/etc/
	done
	install -m644 "$srcdir"/locale.sh etc/profile.d/locale.sh
	install -Dm644 "$srcdir"/os-release usr/lib/os-release
	echo "Panwah" > etc/wah-release

	# Configuring /var
	for dir in cache local opt log/old lib/misc empty; do
		install -d -m755 var/$dir
	done
	install -d -m1777 var/tmp

	# allow setgid games (gid 50) to write scores
	install -d -m775 -g 50 var/games
	ln -s ../run var/run
	ln -s ../run/lock var/lock

	# Creating /usr hierarchy
	for dir in bin include lib share/{misc,pixmaps} src; do
		install -d -m755 usr/$dir
	done
	for dir in {1..8}; do
		install -d -m755 usr/share/man/man$dir
	done
	# Adding lib symlinks
	ln -s usr/lib lib
	[[ $CARCH = 'x86_64' ]] && {
		ln -s usr/lib lib64
		ln -s lib usr/lib64
	}

	ln -s usr/lib lib
	[[ $CARCH = 'aarch64' ]] && {
		ln -s usr/lib libarm64
		ln -s lib usr/libarm64
	}

	# Adding bin symlinks
	ln -s usr/bin bin
	ln -s usr/bin sbin
	ln -s bin usr/sbin

	# Creating /usr/local hierarchy
	for dir in bin etc games include lib man sbin share src; do
		install -d -m755 usr/local/$dir
	done
	ln -s ../man usr/local/share/man

	# Configuring systemd-sysctl
	install -D -m644 $srcdir/sysctl usr/lib/sysctl.d/10-wah.conf

	# Configuring systemd-sysusers
	install -D -m644 $srcdir/sysusers usr/lib/sysusers.d/wah.conf

	# Configuring systemd-tmpfiles
	install -D -m644 $srcdir/tmpfiles usr/lib/tmpfiles.d/wah.conf

	# Configuring systemd.environment-generator
	install -D -m755 $srcdir/env-generator usr/lib/systemd/system-environment-generators/10-wah

	# Adding logos
	install -D -m644 $srcdir/wah-logo{.png,.svg,-text.svg,-text-dark.svg} usr/share/pixmaps
}
